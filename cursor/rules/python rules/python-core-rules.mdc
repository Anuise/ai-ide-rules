---
trigger: "Glob"
description: Python 核心開發準則與通用最佳實踐，適用於所有 Python 專案
globs: ["**/*.py"]
alwaysApply: false
---

# Python 核心開發準則

## 通用原則

- 編寫簡潔、技術性的回應，提供準確的 Python 範例
- 優先考慮可讀性和可維護性
- 遵循 PEP 8 程式碼風格指南
- 使用描述性的變數和函式名稱
- 使用輔助動詞的命名約定（如 `is_active`, `has_permission`, `can_execute`）
- 檔案和目錄使用小寫字母加底線（如 `user_service.py`, `api/routes.py`）

## 程式碼風格

### 命名約定

- 變數和函式：使用 `snake_case`（如 `user_name`, `get_user_data`）
- 常數：使用 `UPPER_SNAKE_CASE`（如 `MAX_RETRIES`, `DEFAULT_TIMEOUT`）
- 類別：使用 `PascalCase`（如 `UserService`, `DatabaseConnection`）
- 私有成員：使用單底線前綴（如 `_internal_method`）

### 型別提示

- 為所有函式簽章新增型別提示
- 優先使用 Pydantic 模型而非原始字典進行輸入驗證（適用於需要結構化設定的場景）
- 使用 `typing` 模組的型別註解（如 `List[str]`, `Dict[str, Any]`, `Optional[int]`）

### 程式設計範式選擇

- **函式式程式設計**：適用於 FastAPI、Flask 等框架，優先使用純函式
- **物件導向程式設計**：適用於 Django、Odoo 等框架，使用類別來組織程式碼
- 根據框架和專案需求選擇合適的範式，避免不必要的抽象

## 錯誤處理和驗證

### 錯誤處理模式

- 在函式開始處處理錯誤和邊界情況（guard clauses）
- 使用早期返回（early return）避免深層巢狀的 if 語句
- 將「正常路徑」放在函式末尾以提高可讀性
- 避免不必要的 else 語句；使用 if-return 模式
- 使用 guard clauses 處理前置條件和無效狀態
- 實作適當的錯誤日誌記錄和使用者友善的錯誤訊息
- 使用自訂錯誤型別或錯誤工廠實作一致的錯誤處理

### 輸入驗證

- 驗證所有外部輸入
- 使用型別檢查和值範圍驗證確保資料完整性
- 對錯誤輸入使用早期返回或拋出例外

## 檔案結構組織

### 專案結構原則

- 使用模組化結構，按功能組織程式碼
- 分離關注點：路由、業務邏輯、資料存取層
- 使用環境變數進行設定管理
- 保持清晰的目錄結構，便於導航和維護

### 程式碼組織

- 保持函式小而專注，每個函式執行單一任務
- 避免全域變數；明確傳遞參數
- 將程式碼組織成邏輯模組和套件
- 分離工具函式、核心演算法和應用程式碼

## 效能優化通用建議

### 程式碼優化

- 優先使用向量化操作而非顯式迴圈（適用於 NumPy、Pandas 等）
- 使用適當的資料結構優化記憶體使用
- 使用適當的資料型別（如 `float32` vs `float64`）優化效能和記憶體
- 使用效能分析工具識別瓶頸並優化

### I/O 操作

- 最小化阻塞 I/O 操作；對 I/O 密集型任務使用非同步操作
- 使用連線池管理資料庫連線
- 實作快取策略減少重複計算和資料庫查詢

### 並行和非同步

- 對於 I/O 密集型任務，使用 `async def` 和非同步函式庫
- 對於 CPU 密集型任務，使用 `def` 和同步操作
- 使用 `asyncio` 或 `concurrent.futures` 進行並行處理

## 相依性管理

- 使用專案指定的套件管理工具（如 `uv`、`pip`、`poetry`）
- 保持相依性版本鎖定以確保可重現性
- 定期更新相依性以取得安全修補程式和功能改進
- 將敏感資訊（API 金鑰、憑證）儲存在環境變數或安全儲存中

## 測試和除錯

- 編寫單元測試確保程式碼正確性
- 使用適當的測試框架（如 `pytest`、`unittest`）
- 實作測試 fixtures 用於資料庫和應用程式設定
- 使用結構化日誌記錄便於除錯和監控
- 在開發環境中使用除錯工具（如 `pdb`、IDE 除錯器）

## 文件和註解

- 為函式和模組新增文件字串，遵循 PEP 257 約定
- 提供清晰的函式目的、參數、回傳值和範例描述
- 註解複雜或非顯而易見的程式碼段以提高可讀性和可維護性
- 保持程式碼自解釋，減少不必要的註解

## 版本控制

- 使用版本控制（如 git）追蹤程式碼變更
- 編寫清晰的提交訊息
- 使用分支策略管理功能開發和修復
- 定期提交程式碼，保持提交歷史清晰

## 安全最佳實踐

- 清理所有外部輸入；永遠不要使用未清理的字串呼叫 shell 命令
- 使用安全預設值（如 TLSv1.2+、強密碼套件）
- 確保金鑰（API 金鑰、憑證）從安全儲存或環境變數載入
- 實施適當的身分驗證和授權機制
- 遵循 OWASP 安全指南
